from courses.models import Course, ProblemSet
from django.test import TestCase
from problems.templates.python.check import Check

from .models import Part, Problem


class PartTestCase(TestCase):
    def test_check_secret(self):
        cour = Course.objects.create()
        prob_set = ProblemSet.objects.create(course=cour)
        prob = Problem.objects.create(problem_set=prob_set)

        part0 = Part.objects.create(problem=prob)
        self.assertEqual(part0.check_secret([]), (True, None))
        self.assertEqual(part0.check_secret(["1"]), (False, None))

        part1 = Part.objects.create(problem=prob, secret='["1"]')
        self.assertEqual(part1.check_secret([]), (False, None))
        self.assertEqual(part1.check_secret(["1"]), (True, None))
        self.assertEqual(part1.check_secret([1]), (False, 0))
        self.assertEqual(part1.check_secret(["1", "2"]), (False, None))

        part2 = Part.objects.create(problem=prob, secret='["1", "2"]')
        self.assertEqual(part2.check_secret([]), (False, None))
        self.assertEqual(part2.check_secret(["1"]), (False, None))
        self.assertEqual(part2.check_secret(["1", "2"]), (True, None))
        self.assertEqual(part2.check_secret([1, "2"]), (False, 0))
        self.assertEqual(part2.check_secret(["1", 2]), (False, 1))
        self.assertEqual(part2.check_secret(["1", "2", "3"]), (False, None))


class ApproxTestCase(TestCase):
    def test_basic(self):
        import numpy as np

        a = np.array([1, 2, 3], dtype=float)
        Check.initialize([{"solution": "..."}])
        Check.part()
        self.assertTrue(Check.approx("np.array([1, 2, 3], dtype='float')", a))
        self.assertFalse(Check.approx("[1, 2, 3]", a))
        self.assertEquals(
            Check.current_part["feedback"][-1],
            "Rezultat ima napačen tip. Pričakovan tip: ndarray, dobljen tip: list.",
        )
        self.assertFalse(Check.approx("np.zeros((2, 3))", a))
        self.assertEquals(
            Check.current_part["feedback"][-1],
            "Obliki se ne ujemata. Pričakovana oblika: (3,), dobljena oblika: (2, 3).",
        )
        self.assertFalse(Check.approx("np.array([1, 2, 3.1])", a))
        self.assertRegexpMatches(
            Check.current_part["feedback"][-1], r"Rezultat ni pravilen\..*"
        )
